# æ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼ˆDepthwise Separable Convolutionï¼‰



## è§†é¢‘å­¦ä¹ 

https://www.bilibili.com/video/BV1BM4m1m7YL/?spm_id_from=333.337.search-card.all.click&vd_source=7ede8e6d75f0ded5e84bb177aa741d76

![image-20250713143412960](ç»“æ„ç†è§£_æ·±åº¦å¯åˆ†ç¦»å·ç§¯ç»“æ„.assets/image-20250713143412960.png)

åˆ†æˆä¸¤éƒ¨åˆ†ï¼š

- æ¯ä¸ªé€šé“å¯¹åº”ä¸€ä¸ªå·ç§¯æ ¸ï¼ŒåŒä¸€ä¸ªå·ç§¯æ ¸ ä¸å»å…³è”ä¸åŒçš„é€šé“
- æœ€åé€šè¿‡ä¸€ä¸ª ï¼ˆ3ï¼Œ1ï¼‰çš„å·ç§¯æ ¸ï¼ŒæŠŠ ä¸åŒçš„é€šé“æƒé‡ç›¸åŠ 

å¦‚æœchannel æƒ³è¦å˜æˆ 256å‘¢ï¼Œdepthwiseé‚£é‡Œçš„å·ç§¯æ ¸å˜æˆ 3\*1\*256



æ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼ˆDepthwise Separable Convolutionï¼‰æ˜¯ç°ä»£è½»é‡çº§ç¥ç»ç½‘ç»œï¼ˆå¦‚ MobileNetã€ShuffleNetã€GTCRN ä¸­çš„ [GTConvBlock](file://D:\10_Python\gtcrn_learning\gtcrn.py#L228-L298)ï¼‰ä¸­å¸¸ç”¨çš„ä¸€ç§å·ç§¯æ“ä½œï¼Œå®ƒå°†æ ‡å‡†å·ç§¯åˆ†è§£ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š

1. **æ·±åº¦å·ç§¯**ï¼ˆDepthwise Convolutionï¼‰
2. **é€ç‚¹å·ç§¯**ï¼ˆPointwise Convolutionï¼‰

è¿™ç§è®¾è®¡å¯ä»¥æ˜¾è‘—å‡å°‘è®¡ç®—é‡å’Œå‚æ•°æ•°é‡ï¼ŒåŒæ—¶ä¿æŒæ¨¡å‹æ€§èƒ½ã€‚

---

## ğŸ§± æ·±åº¦å¯åˆ†ç¦»å·ç§¯çš„ç»„æˆ

### 1ï¸âƒ£ æ·±åº¦å·ç§¯ï¼ˆDepthwise Convolutionï¼‰

> æ¯ä¸ªè¾“å…¥é€šé“ç‹¬ç«‹è¿›è¡Œå·ç§¯æ“ä½œï¼Œä¸è·¨é€šé“èåˆä¿¡æ¯ã€‚

- è¾“å…¥é€šé“æ•°ï¼š`C_in`
- è¾“å‡ºé€šé“æ•°ï¼š`C_out = C_in Ã— multiplier`ï¼ˆé€šå¸¸ multiplier=1ï¼‰
- å·ç§¯æ ¸å¤§å°ï¼š`k x k`ï¼ˆä¾‹å¦‚ 3Ã—3ï¼‰
- æ¯ä¸ªé€šé“ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„ `k x k` å·ç§¯æ ¸
- ä¸æ”¹å˜é€šé“æ•°ï¼ˆå¦‚æœ multiplier=1ï¼‰

### ğŸ”¢ å…¬å¼ï¼š
å¯¹äºæ¯ä¸ªè¾“å…¥é€šé“ $ i \in [0, C_{\text{in}} - 1] $ï¼š
$$
y_i = \sum_{a=0}^{k-1} \sum_{b=0}^{k-1} x_i[a,b] \cdot w_i[a,b]
$$

### ğŸ’¡ ç‰¹ç‚¹ï¼š
- è®¡ç®—é‡å°ï¼ˆæ²¡æœ‰è·¨é€šé“è®¡ç®—ï¼‰
- å‚æ•°å°‘ï¼ˆæ¯ä¸ªé€šé“ä¸€ä¸ªå·ç§¯æ ¸ï¼‰
- ä¿ç•™ç©ºé—´ç»“æ„ï¼Œä½†ä¸èƒ½è·¨é€šé“èåˆç‰¹å¾

---

### 2ï¸âƒ£ é€ç‚¹å·ç§¯ï¼ˆPointwise Convolutionï¼‰

> ä½¿ç”¨ `1x1` å·ç§¯è¿›è¡Œé€šé“ä¹‹é—´çš„çº¿æ€§ç»„åˆï¼ˆå³é€šé“å˜æ¢ï¼‰

- è¾“å…¥é€šé“æ•°ï¼š`C_in`
- è¾“å‡ºé€šé“æ•°ï¼š`C_out`
- å·ç§¯æ ¸å¤§å°ï¼š`1x1`
- æ¯ä¸ªè¾“å‡ºé€šé“éƒ½æ˜¯æ‰€æœ‰è¾“å…¥é€šé“çš„åŠ æƒæ±‚å’Œ

### ğŸ”¢ å…¬å¼ï¼š
å¯¹äºæ¯ä¸ªè¾“å‡ºé€šé“ $ o \in [0, C_{\text{out}} - 1] $ï¼š
$$
y_o = \sum_{i=0}^{C_{\text{in}} - 1} x_i \cdot w_{o,i}
$$

### ğŸ’¡ ç‰¹ç‚¹ï¼š
- è´Ÿè´£è·¨é€šé“ä¿¡æ¯èåˆ
- å¯ä»¥å¢åŠ æˆ–å‡å°‘é€šé“æ•°
- é…åˆæ¿€æ´»å‡½æ•°å¼•å…¥éçº¿æ€§

---

## ğŸ“Œ ç¤ºä¾‹è¯´æ˜

### âœ… è®¾å®šå‚æ•°

```python
import torch
import torch.nn as nn

# å‡è®¾è¾“å…¥å¼ é‡
x = torch.randn(1, 16, 50, 129)  # (B, C, T, F)

# æ·±åº¦å¯åˆ†ç¦»å·ç§¯é…ç½®
depth_conv = nn.Conv2d(
    in_channels=16,
    out_channels=16,
    kernel_size=(3,3),
    stride=(1,1),
    padding=(1,1),
    dilation=(1,1),
    groups=16   # è®¾ç½®ä¸ºè¾“å…¥é€šé“æ•° â†’ æ·±åº¦å·ç§¯
)
point_conv = nn.Conv2d(
    in_channels=16,
    out_channels=32,
    kernel_size=1,
    stride=1,
    padding=0
)
```


### ğŸ“ˆ è¾“å…¥è¾“å‡ºå½¢çŠ¶å˜åŒ–

| å±‚ | è¾“å…¥å½¢çŠ¶ | è¾“å‡ºå½¢çŠ¶ |
|----|----------|------------|
| è¾“å…¥ | `(1, 16, 50, 129)` | - |
| æ·±åº¦å·ç§¯ (`3x3`, `groups=16`) | `(1, 16, 50, 129)` | `(1, 16, 50, 129)` |
| é€ç‚¹å·ç§¯ (`1x1`) | `(1, 16, 50, 129)` | `(1, 32, 50, 129)` |

---

## ğŸ§® å‚æ•°é‡å¯¹æ¯”ï¼ˆå‡è®¾ `C_in=16`, `C_out=32`, `k=3`ï¼‰

| ç±»å‹ | å‚æ•°å…¬å¼ | æ•°é‡ |
|------|--------|------|
| æ ‡å‡†å·ç§¯ | `C_out Ã— C_in Ã— k Ã— k` | `32 Ã— 16 Ã— 3 Ã— 3 = 4608` |
| æ·±åº¦å¯åˆ†ç¦»å·ç§¯ | `C_in Ã— k Ã— k + C_out Ã— C_in Ã— 1 Ã— 1` | `16 Ã— 3 Ã— 3 + 32 Ã— 16 Ã— 1 Ã— 1 = 144 + 512 = 656` |
| å‡å°‘æ¯”ä¾‹ | â€”â€” | ~85% reduction |

---

## ğŸ¯ åœ¨ GTCRN ä¸­çš„åº”ç”¨åœºæ™¯

åœ¨ä½ æä¾›çš„ä»£ç ä¸­ï¼š

```python
self.depth_conv = conv_module(hidden_channels, hidden_channels, kernel_size,
                              stride=stride, padding=padding,
                              dilation=dilation, groups=hidden_channels)
```


- è¿™æ˜¯ä¸€ä¸ª**æ·±åº¦å·ç§¯å±‚**
- `groups=hidden_channels` è¡¨ç¤ºæ¯ä¸ªé€šé“å•ç‹¬å¤„ç†
- ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ª `1x1` çš„ [point_conv2](file://D:\10_Python\gtcrn_learning\gtcrn.py#L0-L0)ï¼Œç”¨äºè·¨é€šé“èåˆ

```python
self.point_conv2 = conv_module(hidden_channels, in_channels//2, 1)
```


è¿™æ ·å°±æ„æˆäº†å®Œæ•´çš„ **æ·±åº¦å¯åˆ†ç¦»å·ç§¯ç»“æ„**

---

## ğŸ§  ä¸¾ä¸ªä¾‹å­ï¼ˆå…·ä½“æ•°å€¼æ¼”ç¤ºï¼‰

### è¾“å…¥å¼ é‡ï¼š
```python
x.shape = (1, 16, 50, 129)  # B=1, C=16, T=50, F=129
```


### Step 1: æ·±åº¦å·ç§¯
```python
depth_conv = nn.Conv2d(16, 16, 3, padding=1, groups=16)
h1 = depth_conv(x)  # h1.shape = (1, 16, 50, 129)
```


### Step 2: 1Ã—1 é€ç‚¹å·ç§¯
```python
point_conv = nn.Conv2d(16, 32, 1)
h2 = point_conv(h1)  # h2.shape = (1, 32, 50, 129)
```


æ­¤æ—¶å®Œæˆäº†ï¼š
- ç©ºé—´å»ºæ¨¡ï¼ˆé€šè¿‡ 3Ã—3 å·ç§¯ï¼‰
- é€šé“å»ºæ¨¡ï¼ˆé€šè¿‡ 1Ã—1 å·ç§¯ï¼‰

---

## ğŸ“Š ç»“æ„æµç¨‹å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰

```
Input:
(B, C_in=16, T=50, F=129)

[Depthwise Conv (3x3)]:
å¯¹æ¯ä¸ªé€šé“åˆ†åˆ«åš 3x3 å·ç§¯ â†’ (B, C_in=16, T=50, F=129)

[Pointwise Conv (1x1)]:
å¯¹é€šé“ç»´åº¦åšçº¿æ€§ç»„åˆ â†’ (B, C_out=32, T=50, F=129)
```


---

## ğŸ§° PyTorch å®ç°ï¼ˆå®Œæ•´æ¨¡å—ï¼‰

```python
class DepthwiseSeparableConv(nn.Module):
    def __init__(self, in_channels, out_channels, kernel_size):
        super().__init__()
        self.depth_conv = nn.Conv2d(in_channels, in_channels, kernel_size,
                                   padding=(kernel_size-1)//2,
                                   groups=in_channels)
        self.point_conv = nn.Conv2d(in_channels, out_channels, 1)

        self.bn = nn.BatchNorm2d(out_channels)
        self.act = nn.PReLU()

    def forward(self, x):
        x = self.depth_conv(x)
        x = self.point_conv(x)
        x = self.bn(x)
        x = self.act(x)
        return x
```


---

## ğŸ“ˆ æ€»ç»“è¡¨æ ¼

| ç»„ä»¶ | åŠŸèƒ½ | æ˜¯å¦è·¨é€šé“äº¤äº’ | å‚æ•°é‡ | æ˜¯å¦é™ç»´/å‡ç»´ |
|------|------|------------------|---------|----------------|
| æ·±åº¦å·ç§¯ | ç©ºé—´å»ºæ¨¡ | âŒ å¦ | `C_in Ã— k Ã— k` | âŒ å¦ |
| é€ç‚¹å·ç§¯ | é€šé“å»ºæ¨¡ | âœ… æ˜¯ | `C_out Ã— C_in Ã— 1 Ã— 1` | âœ… æ˜¯ |

---

## âœ… ä¼˜åŠ¿æ€»ç»“

| ä¼˜åŠ¿ | æè¿° |
|------|------|
| è®¡ç®—é«˜æ•ˆ | å¤§å¹…å‡å°‘ MAC å’Œå‚æ•° |
| å°æ¨¡å‹å‹å¥½ | é€‚åˆéƒ¨ç½²åœ¨è¾¹ç¼˜è®¾å¤‡ï¼ˆå¦‚æ‰‹æœºã€åµŒå…¥å¼ç³»ç»Ÿï¼‰ |
| ä¿æŒç²¾åº¦ | åœ¨åˆç†è®¾è®¡ä¸‹ï¼Œæ€§èƒ½æ¥è¿‘æ ‡å‡†å·ç§¯ |
| æ¨¡å—åŒ–å¼º | å¯çµæ´»ç»„åˆæˆ Inverted Residualã€MobileNet Block ç­‰ |

---

## ğŸ“š ç›¸å…³æ‰©å±•é˜…è¯»

å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œè¿˜å¯ä»¥ç»§ç»­äº†è§£ï¼š
- MobileNetV1/V2/V3 çš„æ”¹è¿›ç­–ç•¥
- ShuffleNet çš„åˆ†ç»„ä¸é€šé“æ··æ´—æœºåˆ¶
- EfficientNet çš„å¤åˆç¼©æ”¾æ–¹æ³•
- æ·±åº¦å¯åˆ†ç¦»å·ç§¯ + Squeeze-and-Excitation çš„ç»“åˆ

---

å¦‚æœä½ å¸Œæœ›æˆ‘ä¸ºä½ ç”»å‡ºè¯¥æ¨¡å—çš„å¯è§†åŒ–ç»“æ„å›¾ã€ç»™å‡ºå®Œæ•´çš„è®­ç»ƒå»ºè®®ã€æˆ–è€…å¸®ä½ åˆ†ææŸä¸ªå…·ä½“å±‚çš„å‚æ•°è§„æ¨¡ï¼Œä¹Ÿå¯ä»¥ç»§ç»­é—®æˆ‘ï¼